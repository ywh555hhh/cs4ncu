# PR å…³é—­æ—¶æ¸…ç†é¢„è§ˆ
name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  cleanup:
    name: æ¸…ç† PR é¢„è§ˆ
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1

      - name: æ¸…ç†æ­¤ PR çš„é¢„è§ˆ
        run: |
          pr_number="${{ github.event.number }}"
          preview_path="pr-preview/$pr_number"
          
          if [ -d "$preview_path" ]; then
            echo "æ¸…ç† PR #$pr_number çš„é¢„è§ˆç›®å½•: $preview_path"
            rm -rf "$preview_path"
            
            # æ£€æŸ¥ pr-preview ç›®å½•æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™åˆ é™¤
            if [ -d "pr-preview" ] && [ -z "$(ls -A pr-preview)" ]; then
              echo "pr-preview ç›®å½•ä¸ºç©ºï¼Œåˆ é™¤è¯¥ç›®å½•"
              rm -rf pr-preview
            fi
            
            git config user.name github-actions
            git config user.email github-actions@github.com
            git add .
            
            if git diff --staged --quiet; then
              echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
            else
              git commit -m "æ¸…ç† PR #$pr_number çš„é¢„è§ˆ"
              git push
              echo "âœ… å·²æ¸…ç† PR #$pr_number çš„é¢„è§ˆ"
            fi
          else
            echo "PR #$pr_number æ²¡æœ‰é¢„è§ˆç›®å½•éœ€è¦æ¸…ç†"
          fi

      - name: æ·»åŠ æ¸…ç†å®Œæˆè¯„è®º
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ğŸ§¹ é¢„è§ˆæ¸…ç†å®Œæˆ
              
              PR å·²åˆå¹¶ï¼Œç›¸å…³çš„æ–‡æ¡£é¢„è§ˆå·²è‡ªåŠ¨æ¸…ç†ã€‚
              
              ğŸ“– **æ­£å¼æ–‡æ¡£**: [æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)
              
              ---
              <sub>ğŸ¤– æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ</sub>`
            });