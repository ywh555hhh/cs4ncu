# æ­£å¼éƒ¨ç½²æ–‡æ¡£åˆ°ç”Ÿäº§ç¯å¢ƒ
name: Deploy CS for NCU Docs

# å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # 1. è‡ªåŠ¨è§¦å‘ï¼šå½“æœ‰ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶
  push:
    branches:
      - main  # ç¡®ä¿è¿™æ˜¯ä½ çš„ä¸»åˆ†æ”¯åç§°

  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸ä½ åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

# å®šä¹‰å·¥ä½œæµæ‰€éœ€çš„æƒé™ï¼Œä»¥å…è®¸æ¨é€åˆ° gh-pages åˆ†æ”¯
permissions:
  contents: write
  pages: write
  id-token: write

# é¿å…å¹¶å‘éƒ¨ç½²
concurrency:
  group: pages-deployment
  cancel-in-progress: false

# å·¥ä½œæµä¸­è¿è¡Œçš„ä»»åŠ¡
jobs:
  # æ£€æŸ¥å˜æ›´å’Œæ¸…ç†æ—§é¢„è§ˆ
  cleanup-old-previews:
    name: æ¸…ç†è¿‡æœŸé¢„è§ˆ
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: æ¸…ç†å·²å…³é—­ PR çš„é¢„è§ˆ
        run: |
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ pr-preview ç›®å½•
          if [ ! -d "pr-preview" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ° pr-preview ç›®å½•ï¼Œè·³è¿‡æ¸…ç†"
            exit 0
          fi
          
          # è·å–æ‰€æœ‰æ‰“å¼€çš„ PR ç¼–å·
          open_prs=$(curl -s "https://api.github.com/repos/${{ github.repository }}/pulls?state=open" | jq -r '.[].number')
          
          # è·å–ç°æœ‰çš„é¢„è§ˆç›®å½•
          existing_previews=$(ls pr-preview/ 2>/dev/null || echo "")
          
          cleaned=false
          for preview_dir in $existing_previews; do
            if [[ "$preview_dir" =~ ^[0-9]+$ ]]; then
              if ! echo "$open_prs" | grep -q "^$preview_dir$"; then
                echo "æ¸…ç†å·²å…³é—­ PR #$preview_dir çš„é¢„è§ˆ"
                rm -rf "pr-preview/$preview_dir"
                cleaned=true
              fi
            fi
          done
          
          if [ "$cleaned" = "true" ]; then
            git config user.name github-actions
            git config user.email github-actions@github.com
            git add pr-preview/
            if git diff --staged --quiet; then
              echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
            else
              git commit -m "æ¸…ç†å·²å…³é—­ PR çš„é¢„è§ˆç›®å½•"
              git push
            fi
          else
            echo "æ²¡æœ‰éœ€è¦æ¸…ç†çš„é¢„è§ˆç›®å½•"
          fi

  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    needs: cleanup-old-previews
    # è¿è¡Œæ­¤ä»»åŠ¡çš„è™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}

    # ä»»åŠ¡ä¸­çš„æ­¥éª¤
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä½ çš„ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # æ­¥éª¤ 3: å®‰è£… uv
      - name: Install uv
        run: pipx install uv

      # æ­¥éª¤ 4: é…ç½®ä¾èµ–ç¼“å­˜ (å…³é”®æ€§èƒ½ä¼˜åŒ–)
      - name: Cache uv virtual environment
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      # æ­¥éª¤ 5: åŒæ­¥ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
      - name: Install dependencies with uv
        run: uv sync

      # æ­¥éª¤ 6: æ„å»ºæ–‡æ¡£ç½‘ç«™ (ä½¿ç”¨ --strict ä¿è¯è´¨é‡)
      - name: Build documentation
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºç”Ÿäº§ç¯å¢ƒæ–‡æ¡£..."
          uv run mkdocs build --clean --strict
          echo "âœ… ç”Ÿäº§ç¯å¢ƒæ–‡æ¡£æ„å»ºæˆåŠŸï¼"

      # æ­¥éª¤ 7: éªŒè¯æ„å»ºäº§ç‰©
      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          if [ ! -d "site" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šsite ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "site/index.html" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šindex.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "ğŸ“Š ç”Ÿäº§æ„å»ºç»Ÿè®¡:"
          echo "- æ€»æ–‡ä»¶æ•°: $(find site -type f | wc -l)"
          echo "- HTML æ–‡ä»¶æ•°: $(find site -name "*.html" | wc -l)"
          echo "- æ€»å¤§å°: $(du -sh site | cut -f1)"

      # æ­¥éª¤ 8: éƒ¨ç½²åˆ° GitHub Pages
      # è¿™ä¸€æ­¥ä¼šè‡ªåŠ¨å°† `./site` ç›®å½•çš„å†…å®¹æ¨é€åˆ°æœ¬ä»“åº“çš„ `gh-pages` åˆ†æ”¯
      - name: Deploy to GitHub Pages
        id: deployment
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          keep_files: true  # ä¿ç•™ pr-preview ç›®å½•
          exclude_assets: 'pr-preview/**'