# PR é¢„è§ˆå’ŒéªŒè¯å·¥ä½œæµ
name: PR Preview & Validation

# è§¦å‘æ¡ä»¶ï¼šPR åˆ›å»ºã€æ›´æ–°æˆ–åŒæ­¥æ—¶
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

# å·¥ä½œæµæƒé™
permissions:
  contents: read
  pull-requests: write
  pages: write
  id-token: write

# é¿å…å¹¶å‘è¿è¡Œç›¸åŒ PR çš„å¤šä¸ªå·¥ä½œæµ
concurrency:
  group: pr-preview-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  # æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»ºæ–‡æ¡£
  check-changes:
    name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
    runs-on: ubuntu-latest
    outputs:
      docs-changed: ${{ steps.changes.outputs.docs }}
      skip-build: ${{ steps.changes.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥å˜æ›´çš„æ–‡ä»¶
        id: changes
        run: |
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          changed_files=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$changed_files"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æ¡£ç›¸å…³çš„å˜æ›´
          docs_changed=false
          skip_build=false
          
          # éœ€è¦è§¦å‘æ„å»ºçš„æ–‡ä»¶ç±»å‹
          build_patterns=(
            "docs/"
            "mkdocs.yml"
            "pyproject.toml"
            "uv.lock"
            "overrides/"
            ".github/workflows/"
            "README.md"
          )
          
          # å¯ä»¥è·³è¿‡æ„å»ºçš„æ–‡ä»¶ç±»å‹ï¼ˆå¦‚æœåªæœ‰è¿™äº›æ–‡ä»¶å˜æ›´ï¼‰
          skip_patterns=(
            "class0/"
            "main.py"
            ".gitignore"
            ".mailmap"
            ".python-version"
            "drafts/"
          )
          
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ„å»ºçš„æ–‡ä»¶å˜æ›´
          for pattern in "${build_patterns[@]}"; do
            if echo "$changed_files" | grep -q "^$pattern"; then
              docs_changed=true
              break
            fi
          done
          
          # å¦‚æœæ²¡æœ‰æ–‡æ¡£ç›¸å…³å˜æ›´ï¼Œæ£€æŸ¥æ˜¯å¦åªæœ‰å¯è·³è¿‡çš„æ–‡ä»¶å˜æ›´
          if [ "$docs_changed" = "false" ]; then
            all_skippable=true
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                is_skippable=false
                for pattern in "${skip_patterns[@]}"; do
                  if [[ "$file" == $pattern* ]]; then
                    is_skippable=true
                    break
                  fi
                done
                if [ "$is_skippable" = "false" ]; then
                  all_skippable=false
                  break
                fi
              fi
            done <<< "$changed_files"
            
            if [ "$all_skippable" = "true" ]; then
              skip_build=true
            fi
          fi
          
          echo "docs=$docs_changed" >> $GITHUB_OUTPUT
          echo "skip=$skip_build" >> $GITHUB_OUTPUT
          echo "æ–‡æ¡£ç›¸å…³å˜æ›´: $docs_changed"
          echo "è·³è¿‡æ„å»º: $skip_build"

  # æ„å»ºå’ŒéªŒè¯æ–‡æ¡£
  build-and-validate:
    name: æ„å»ºéªŒè¯æ–‡æ¡£
    needs: check-changes
    if: needs.check-changes.outputs.skip-build != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: å®‰è£… uv
        run: pipx install uv

      - name: é…ç½®ä¾èµ–ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: å®‰è£…ä¾èµ–
        run: uv sync

      - name: æ„å»ºæ–‡æ¡£ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºæ–‡æ¡£..."
          uv run mkdocs build --clean --strict
          echo "âœ… æ–‡æ¡£æ„å»ºæˆåŠŸï¼"

      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          if [ ! -d "site" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šsite ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "site/index.html" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šindex.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©æ£€æŸ¥é€šè¿‡"
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "- æ€»æ–‡ä»¶æ•°: $(find site -type f | wc -l)"
          echo "- HTML æ–‡ä»¶æ•°: $(find site -name "*.html" | wc -l)"
          echo "- æ€»å¤§å°: $(du -sh site | cut -f1)"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: pr-preview-${{ github.event.number }}
          path: site/
          retention-days: 7

  # éƒ¨ç½²é¢„è§ˆï¼ˆå¦‚æœæ˜¯ fork ä»“åº“çš„ PRï¼Œåˆ™è·³è¿‡ï¼‰
  deploy-preview:
    name: éƒ¨ç½²é¢„è§ˆ
    needs: [check-changes, build-and-validate]
    if: |
      needs.check-changes.outputs.skip-build != 'true' && 
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    environment:
      name: pr-preview-${{ github.event.number }}
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: pr-preview-${{ github.event.number }}
          path: site/

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: pr-preview/${{ github.event.number }}
          keep_files: false

      - name: æ·»åŠ é¢„è§ˆé“¾æ¥è¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.number;
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-preview/${prNumber}/`;
            
            // æŸ¥æ‰¾ç°æœ‰çš„é¢„è§ˆè¯„è®º
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“– æ–‡æ¡£é¢„è§ˆ')
            );
            
            const commentBody = `## ğŸ“– æ–‡æ¡£é¢„è§ˆå·²å°±ç»ªï¼
            
            âœ… **æ„å»ºçŠ¶æ€**: æˆåŠŸ
            ğŸ”— **é¢„è§ˆé“¾æ¥**: [ç‚¹å‡»æŸ¥çœ‹é¢„è§ˆ](${previewUrl})
            ğŸ•’ **æœ€åæ›´æ–°**: ${new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})}
            
            > ğŸ’¡ é¢„è§ˆä¼šåœ¨ PR å…³é—­åè‡ªåŠ¨æ¸…ç†ã€‚æ­¤é¢„è§ˆåæ˜ äº†å½“å‰ PR çš„æœ€æ–°å˜æ›´ã€‚
            
            ---
            <sub>ğŸ¤– æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ</sub>`;
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  # é€šçŸ¥æ„å»ºç»“æœ
  notify-result:
    name: é€šçŸ¥ç»“æœ
    needs: [check-changes, build-and-validate]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: é€šçŸ¥è·³è¿‡æ„å»º
        if: needs.check-changes.outputs.skip-build == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## â­ï¸ è·³è¿‡æ–‡æ¡£æ„å»º
              
              æ­¤ PR æ²¡æœ‰åŒ…å«éœ€è¦é‡æ–°æ„å»ºæ–‡æ¡£çš„å˜æ›´ã€‚
              
              ğŸ“‹ **å˜æ›´ç±»å‹**: ä»£ç æˆ–é…ç½®æ–‡ä»¶
              âš¡ **æ“ä½œ**: è·³è¿‡æ–‡æ¡£æ„å»ºä»¥èŠ‚çœèµ„æº
              
              ---
              <sub>ğŸ¤– æ­¤æ¶ˆæ¯ç”±æ™ºèƒ½æ–‡ä»¶æ£€æµ‹ç”Ÿæˆ</sub>`
            });

      - name: é€šçŸ¥æ„å»ºå¤±è´¥
        if: needs.build-and-validate.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## âŒ æ–‡æ¡£æ„å»ºå¤±è´¥
              
              PR ä¸­çš„å˜æ›´å¯¼è‡´æ–‡æ¡£æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤é—®é¢˜ã€‚
              
              ğŸ” **å»ºè®®æ“ä½œ**:
              1. æŸ¥çœ‹ [Actions æ—¥å¿—](${context.payload.pull_request.html_url}/checks) äº†è§£å…·ä½“é”™è¯¯
              2. åœ¨æœ¬åœ°è¿è¡Œ \`uv run mkdocs build --strict\` å¤ç°é—®é¢˜
              3. ä¿®å¤é”™è¯¯åé‡æ–°æ¨é€
              
              ---
              <sub>ğŸ¤– æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ</sub>`
            });