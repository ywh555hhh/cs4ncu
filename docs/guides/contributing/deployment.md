---
tags:
  - Topic-DevOps
  - Topic-GitHub
  - Type-Guide
  - Level-Intermediate
  - Action-Deployment
  - Context-Project
---

# 网站部署指南：自动化与规范

本文档解释了 `CS for NCU` 项目网站的部署流程。我们采用了一套基于 GitHub Actions 的自动化工作流，以确保每一次发布都是**安全、可靠且一致的**。

---

## 核心理念：发布权由“系统”而非“个人”掌管

在多人协作的项目中，如果允许任何人随时从自己的电脑上手动发布网站，将会导致一系列问题：

*   **绕过审查**：未经同事 review 的内容可能被直接发布上线。
*   **环境不一致**：不同开发者的本地环境差异，可能导致构建出的网站效果千奇百怪。
*   **缺乏追溯**：难以清晰地追溯每一次线上更新对应的是哪一次代码提交。

!!! success "我们的解决方案"
    我们将发布权从“**不确定的个人**”手中，转移到了“**可靠的自动化系统**”上。只有当代码通过了审查并被合并到主分支 `main` 后，系统才会自动执行**最终的**正式发布。

---

## 自动化部署工作流 (`deploy-docs.yml`)

我们的自动化部署流程定义在仓库的 `.github/workflows/deploy-docs.yml` 文件中。

### 触发条件

工作流由两种事件触发：

1.  **推送到 `main` 分支 (`push`)**：
    *   **合并 PR 时**：当一个 Pull Request 被合并到 `main` 分支，此事件触发，执行**正式的网站发布**。
    *   **直接推送到你自己的分支时**：当你将本地分支推送到你在 GitHub 上的 Fork 仓库时，此事件同样会触发。这会运行一套**预览部署**。

2.  **手动触发 (`workflow_dispatch`)**：
    *   允许项目维护者在 GitHub Actions 页面手动运行部署，用于特殊情况。

### 核心步骤

无论由何种事件触发，工作流都将执行一套标准化的构建与部署流程：

1.  **环境准备**：在一个纯净、统一的 `ubuntu-latest` 虚拟环境中，使用 `uv` 和缓存机制快速安装所有依赖。
2.  **构建网站**：运行 `uv run mkdocs build --strict` 命令。`--strict` 参数会确保任何构建警告（如错误的内部链接）都导致流程失败，从而提前暴露问题。
3.  **部署到 Pages**：将构建生成的 `site` 目录中的内容，安全地推送到触发工作流的那个仓库的 `gh-pages` 分支。

---

## 这对贡献者意味着什么？

!!! tip "你的工作流程：简单且带“预览”功能"
    作为贡献者，你**完全不需要在本地执行任何部署命令**。你的工作流程如下：

    1.  **本地修改**：在你自己的分支上完成内容的创作和修改。
    2.  **推送进行“预部署”检查（可选但推荐）**：
        *   将你的本地分支推送到你在 GitHub 上的 Fork 仓库 (`git push origin your-branch-name`)。
        *   这个 `push` 动作会触发你的 Fork 仓库中的 GitHub Actions 工作流。
        *   **你可以进入你的 Fork 仓库的 Actions 页面，查看构建是否成功。** 这就像一次“彩排”，能帮你提前发现本地预览时没注意到的问题（比如链接错误），确保你的代码在真实的构建环境中是健康的。
    3.  **发起 Pull Request**：当你确认一切无误后，向我们的主仓库发起 PR。
    4.  **等待合并与正式发布**：一旦你的 PR 被审查并合并到 `main` 分支，主仓库的 GitHub Actions 会被再次触发，这一次，它将执行**最终的、正式的网站发布**。

这套流程不仅保证了项目质量，也为你提供了一个强大的“云端构建”工具，让你的贡献过程更加自信和顺畅
---

## 🚀 新功能：增强的 PR 验证和预览系统

!!! success "重大更新"
    我们新增了专门的 Pull Request 验证和预览系统，让贡献体验更加顺畅！

### 智能构建检测

新的 PR 工作流具备智能文件检测功能，仅在必要时执行构建：

**🟢 触发构建的文件变更**：
- `docs/` 目录下的所有文档文件
- `mkdocs.yml` 配置文件
- `pyproject.toml` 和 `uv.lock` 依赖文件  
- `overrides/` 主题自定义文件
- `.github/workflows/` 工作流文件
- `README.md` 项目说明

**🟡 跳过构建的文件变更**：
- `class0/` 课程资料
- `main.py` 示例代码
- `.gitignore`、`.mailmap` 等配置文件
- `drafts/` 草稿目录

### PR 自动化流程

当你创建或更新 Pull Request 时，系统会自动：

1. **🔍 智能检测变更**：分析哪些文件发生了变更，决定是否需要构建
2. **🔨 构建验证**：在严格模式下构建文档，确保没有错误或警告
3. **🌐 部署预览**：为 PR 创建独立的预览环境
4. **💬 自动评论**：在 PR 中添加预览链接和构建状态

### 预览环境特性

- **独立 URL**：每个 PR 都有独立的预览地址
- **实时更新**：每次推送新提交都会自动更新预览
- **自动清理**：PR 关闭后自动清理预览资源
- **一键访问**：直接从 PR 评论区点击链接查看预览

### 智能通知系统

系统会在 PR 中自动添加不同类型的通知评论：

- ✅ **构建成功**：提供预览链接和更新时间
- ⏭️ **跳过构建**：说明跳过原因（如仅修改了代码文件）
- ❌ **构建失败**：提供详细的错误排查指导
- 🧹 **预览清理**：PR 合并后确认预览已清理

### 💡 对贡献者的好处

!!! tip "全新体验"
    - **更快反馈**：智能跳过不必要的构建，节省等待时间
    - **即时预览**：每个 PR 都能获得独立的预览链接
    - **提前验证**：在合并前就能发现潜在问题
    - **资源节省**：只在必要时运行构建，减少 CI/CD 资源消耗
    - **零配置**：所有功能都是自动的，无需额外设置

---

## 🔧 工作流详解

### 1. PR 预览工作流 (`pr-preview.yml`)

专门处理 Pull Request 的验证和预览部署：

- **触发条件**：PR 创建、更新或重新打开
- **智能检测**：分析文件变更决定是否构建
- **并发控制**：避免同一 PR 的多个构建任务冲突
- **预览部署**：为每个 PR 创建独立的预览环境

### 2. 生产部署工作流 (`deploy-docs.yml`)

处理正式的生产环境部署：

- **触发条件**：代码合并到 main 分支
- **清理功能**：自动清理已关闭 PR 的预览
- **生产构建**：构建并部署最终版本
- **环境隔离**：保持预览和生产环境独立

### 3. 预览清理工作流 (`cleanup-pr-preview.yml`)

确保预览资源的及时清理：

- **触发条件**：PR 关闭时
- **自动清理**：删除对应的预览目录
- **状态通知**：在 PR 中确认清理完成

---

## 🛠️ 故障排除

### 常见问题

**Q: 为什么我的 PR 没有生成预览？**
- 检查是否修改了需要构建的文件类型
- 确认 GitHub Actions 有足够权限
- 查看 Actions 日志了解具体错误

**Q: 预览链接无法访问？**
- 预览部署可能需要几分钟时间
- 检查 GitHub Pages 是否已启用
- 确认仓库有正确的访问权限

**Q: 如何手动触发构建？**
- 对 PR 进行任意提交（如添加空行）
- 关闭并重新打开 PR
- 联系仓库维护者手动触发

### 调试建议

1. **查看 Actions 日志**：点击 PR 页面的 "Checks" 标签
2. **本地验证**：运行 `uv run mkdocs build --strict` 
3. **检查文件路径**：确保文件路径和命名正确
4. **验证语法**：检查 Markdown 语法和链接正确性
